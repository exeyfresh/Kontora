@page "/billpage"
@using kontora1
@using Npgsql
@inject NpgsqlConnection dbConnection

<div class="container">
    <div style="display:flex; align-items:center; gap:10px;">
        <button class="add-button" @onclick="ShowAddDialog">+ Выставить счет</button>
    </div>

    <table class="bill-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Клиент</th>
                <th>Сумма</th>
                <th>Статус</th>
                <th>Дата выставления</th>
                <th>Дата оплаты</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var bill in bills)
            {
                <tr class="@(bill.is_paid == "Оплачен" ? "paid-row" : "unpaid-row")">
                    <td>@bill.id_bill</td>
                    <td>@(GetClientName(bill.id_user))</td>
                    <td>@bill.price.ToString("0.00")</td>
                    <td>@bill.is_paid</td>
                    <td>@bill.date_issued.ToString("dd.MM.yyyy")</td>
                    <td>@(bill.date_paid.HasValue ? bill.date_paid.Value.ToString("dd.MM.yyyy") : "-")</td>
                    <td>
                        <div class="action-buttons">
                            @if (bill.is_paid != "Оплачен")
                            {
                                <button class="edit-button" @onclick="() => Pay(bill.id_bill)">Принять оплату</button>
                            }
                            <button class="delete-button" @onclick="() => Delete(bill.id_bill)">Удалить</button>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    @if (showAddModal)
    {
        <div class="modal">
            <div class="modal-content">
                <h3>Выставить счет</h3>
                <div class="form-group">
                    <label>Клиент:</label>
                    <select @bind="newBill.id_user" class="client-select">
                        <option value="0">-- Выберите клиента --</option>
                        @foreach (var client in clients)
                        {
                            <option value="@client.id">@($"{client.lastname} {client.firstname}")</option>
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label>Сумма:</label>
                    <input type="number" step="0.01" @bind="newBill.price" />
                </div>
                <div class="form-group">
                    <label>Дата выставления:</label>
                    <input type="date" @bind="newBill.date_issued" format-value="yyyy-MM-dd" />
                </div>
                <div class="form-group">
                    <button class="save-button" @onclick="AddBill" disabled="@(newBill.id_user == 0)">Сохранить</button>
                    <button @onclick="() => showAddModal = false">Отмена</button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<Bill> bills = new();
    private List<Client> clients = new();
    private bool showAddModal = false;
    private Bill newBill = new();


    protected override async Task OnInitializedAsync()
    {
        await LoadBills();
        await LoadClients();
    }

    private async Task LoadBills()
    {
        bills = Bill.GetBills(dbConnection);
    }

    private async Task LoadClients()
    {
        clients = Client.GetAllClients(dbConnection);
    }

    private string GetClientName(int id)
    {
        var client = clients.FirstOrDefault(c => c.id == id);
        return client != null ? $"{client.lastname} {client.firstname}" : $"Клиент (ID: {id})";
    }

    private void ShowAddDialog()
    {
        newBill = new Bill { id_user = 0 }; // остальные поля инициализируются в классе
        showAddModal = true;
    }

    private void AddBill()
    {
        if (newBill.id_user == 0) return;

        if (Bill.CreateBill(dbConnection, newBill))
        {
            showAddModal = false;
            LoadBills();
        }
    }

    private void Pay(int id)
    {
        if (Bill.PayBill(dbConnection, id))
        {
            LoadBills();
        }
    }

    private void Delete(int id)
    {
        if (Bill.DeleteBill(dbConnection, id))
        {
            LoadBills();
        }
    }
}
<style>
    .container {
        margin-top: 20px;
        padding: 0 20px;
    }

    .bill-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }

        .bill-table th, .bill-table td {
            border: 1px solid #ccc;
            padding: 8px 12px;
            text-align: center;
        }

        .bill-table th {
            background-color: slategray;
            color: white;
        }

        .bill-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

    .action-buttons {
        display: flex;
        gap: 5px;
        justify-content: center;
    }

    .edit-button {
        background-color: #ffc107;
        color: white;
        padding: 5px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

        .edit-button:hover {
            background-color: #e0a800;
        }

    .delete-button {
        background-color: #dc3545;
        color: white;
        padding: 5px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

        .delete-button:hover {
            background-color: #c82333;
        }

    .add-button {
        margin-bottom: 10px;
        padding: 10px 15px;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

        .add-button:hover {
            background-color: #218838;
        }

    .paid-row {
        background-color: #d4edda !important;
    }

    .unpaid-row {
        background-color: #f8d7da !important;
    }

    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        width: 300px;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .modal-content input,
    .modal-content select {
        width: 100%;
        padding: 8px;
        box-sizing: border-box;
        margin-top: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 16px;
        color: #333;
    }

        .modal-content input:focus,
        .modal-content select:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
        }

    .save-button {
        background-color: #007bff;
        color: white;
        padding: 5px 10px;
        margin-right: 5px;
        border: none;
        border-radius: 4px;
    }

        .save-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

</style>
